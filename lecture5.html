<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Statistics: Data analysis and modelling</title>
    <meta charset="utf-8" />
    <meta name="author" content="Maarten Speekenbrink" />
    <script src="libs/header-attrs-2.28/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="mycss.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Statistics: Data analysis and modelling
]
.subtitle[
## Week 5 highlights: Linear mixed-effects models
]
.author[
### Maarten Speekenbrink
]

---









## Linear mixed-effects models

`$$\begin{aligned} Y_{i,k} &amp;= (\beta_0 + \gamma_{0,k}) + (\beta_1 + \gamma_{1,k}) \times X_{1,i,k} + \ldots + (\beta_m + \gamma_{m,k}) \times X_{m,i,k} + \epsilon_{i,k} \\
&amp; \epsilon_{i,k} \sim \mathbf{Normal}(0,\sigma_{\epsilon}) \\
&amp; \gamma_{j,k} \sim \mathbf{Normal}(\boldsymbol{0}, \boldsymbol{\Sigma}_\gamma) \end{aligned}$$`

* `\(Y_{i,k}\)` is observation `\(i\)` within **unit of observation** `\(k\)` `\((i=1,\ldots, n_k)\)`
* `\(\beta_j\)` is a __fixed effect__ `\((j=0, \ldots, m)\)`
* `\(\gamma_{j,k}\)` is a __random effect__ for parameter `\(j\)` and unit of observation `\(k\)`.
* `\(\boldsymbol{\Sigma}_\gamma\)` is the __covariance matrix__ of the random effects.

Key intuitions: 

* A linear-mixed effects model allows for what is effectively a different regression equation for each unit of observation `\(j\)`.
* We need multiple observations `\(i\)` for each unit of observation `\(j\)` to estimate such a model.
* Rather than estimating separate models for each subset `\(j\)`, we can estimate a single model over all subsets, assuming the random effects are drawn from a multivariate Normal distribution.
* Each fixed effect `\(\beta_k\)` can be viewed as the average effect over all possible units of observation `\(j\)`.

---

## Speed-dating experiment

`\(n=102\)` participants were randomly matched with between 5 and 20 potential partners for a 4 minute conversation. They rated how much they liked their speed dating partners, as well as their attractiveness, sincerity, intelligence, fun, and ambition.



&lt;img src="lecture5_files/figure-html/unnamed-chunk-3-1.png" width="90%" style="display: block; margin: auto;" /&gt;

---

## Speed-dating experiment

`\(n=102\)` participants were randomly matched with between 5 and 20 potential partners for a 4 minute conversation. They rated how much they liked their speed dating partners, as well as their attractiveness, sincerity, intelligence, fun, and ambition.

&lt;img src="lecture5_files/figure-html/unnamed-chunk-4-1.png" width="90%" style="display: block; margin: auto;" /&gt;


---

## Linear model

.scrollable[

``` r
contrasts(dat$gender) &lt;- contr.sum(2)
mod0 &lt;- lm(like ~ attr*gender + intel*gender + fun*gender +
             sinc*gender + amb*gender, data=dat)
summary(mod0)
```

```

Call:
lm(formula = like ~ attr * gender + intel * gender + fun * gender + 
    sinc * gender + amb * gender, data = dat)

Residuals:
    Min      1Q  Median      3Q     Max 
-4.7650 -0.6388  0.0567  0.6921  4.8944 

Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)    6.159189   0.031930 192.894  &lt; 2e-16 ***
attr           0.340174   0.020368  16.702  &lt; 2e-16 ***
gender1       -0.015645   0.031930  -0.490 0.624222    
intel          0.144987   0.031937   4.540 6.12e-06 ***
fun            0.358019   0.022987  15.575  &lt; 2e-16 ***
sinc           0.130513   0.027762   4.701 2.85e-06 ***
amb            0.057533   0.024456   2.352 0.018788 *  
attr:gender1  -0.076551   0.020368  -3.758 0.000178 ***
gender1:intel  0.026543   0.031937   0.831 0.406054    
gender1:fun    0.039766   0.022987   1.730 0.083865 .  
gender1:sinc   0.046410   0.027762   1.672 0.094811 .  
gender1:amb   -0.001041   0.024456  -0.043 0.966063    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.125 on 1377 degrees of freedom
  (173 observations deleted due to missingness)
Multiple R-squared:  0.6321,	Adjusted R-squared:  0.6292 
F-statistic: 215.1 on 11 and 1377 DF,  p-value: &lt; 2.2e-16
```
]

---

## Speed-dating experiment

`\(n=102\)` participants were randomly matched with between 5 and 20 potential partners for a 4 minute conversation. They rated how much they liked their speed dating partners, as well as their attractiveness, sincerity, intelligence, fun, and ambition.

Two sources of possible dependency:

* Each participant rates multiple partners
* Each partner is rated by multiple participants

---

## Crossed random intercepts and slopes

.scrollable[

``` r
mod &lt;- afex::mixed(like ~ attr*gender + intel*gender + fun*gender + 
                     sinc*gender + amb*gender + 
                     (1 + attr + intel + fun + sinc + amb|iid) + 
                     (1 + attr + intel + fun + sinc + amb|pid), 
                   data=dat)
summary(mod)
```

```
Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: like ~ attr * gender + intel * gender + fun * gender + sinc *  
    gender + amb * gender + (1 + attr + intel + fun + sinc +  
    amb | iid) + (1 + attr + intel + fun + sinc + amb | pid)
   Data: data

REML criterion at convergence: 3978.6

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.0982 -0.5296 -0.0072  0.5487  3.2685 

Random effects:
 Groups   Name        Variance Std.Dev. Corr                         
 pid      (Intercept) 0.013752 0.11727                               
          attr        0.016055 0.12671  -0.19                        
          intel       0.028042 0.16746   0.48 -0.07                  
          fun         0.008633 0.09291   0.04 -0.23 -0.03            
          sinc        0.004322 0.06574  -0.62 -0.22 -0.86 -0.23      
          amb         0.032014 0.17892  -0.07 -0.15 -0.85 -0.25  0.80
 iid      (Intercept) 0.279970 0.52912                               
          attr        0.051010 0.22585  -0.31                        
          intel       0.019814 0.14076  -0.28 -0.27                  
          fun         0.024787 0.15744   0.16 -0.48 -0.03            
          sinc        0.016506 0.12848   0.17 -0.83  0.66  0.59      
          amb         0.001428 0.03779  -0.71 -0.35  0.35 -0.14  0.22
 Residual             0.672950 0.82034                               
Number of obs: 1389, groups:  pid, 102; iid, 100

Fixed effects:
                Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)     6.173365   0.065176  92.655036  94.718  &lt; 2e-16 ***
attr            0.381684   0.034390 103.793626  11.099  &lt; 2e-16 ***
gender1         0.043267   0.065176  92.655036   0.664 0.508441    
intel           0.137184   0.038451 106.061653   3.568 0.000542 ***
fun             0.337749   0.029781  78.672490  11.341  &lt; 2e-16 ***
sinc            0.153706   0.030418  93.265543   5.053 2.16e-06 ***
amb             0.081155   0.030858 103.667383   2.630 0.009840 ** 
attr:gender1   -0.059531   0.034390 103.793626  -1.731 0.086418 .  
gender1:intel  -0.009899   0.038451 106.061653  -0.257 0.797343    
gender1:fun    -0.006991   0.029781  78.672490  -0.235 0.815016    
gender1:sinc    0.069267   0.030418  93.265543   2.277 0.025060 *  
gender1:amb     0.039100   0.030858 103.667383   1.267 0.207959    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) attr   gendr1 intel  fun    sinc   amb    attr:1 gndr1:n
attr        -0.219                                                         
gender1      0.010  0.033                                                  
intel       -0.050 -0.112 -0.018                                           
fun          0.036 -0.435 -0.014 -0.044                                    
sinc         0.037 -0.334  0.041 -0.281  0.063                             
amb         -0.084 -0.094 -0.073 -0.429 -0.192  0.091                      
attr:gendr1  0.033  0.028 -0.219 -0.028 -0.009 -0.010  0.012               
gender1:ntl -0.018 -0.028 -0.050  0.030  0.049 -0.012 -0.052 -0.112        
gender1:fun -0.014 -0.009  0.036  0.049  0.000 -0.003 -0.036 -0.435 -0.044 
gender1:snc  0.041 -0.010  0.037 -0.012 -0.003 -0.002 -0.004 -0.334 -0.281 
gender1:amb -0.073  0.012 -0.084 -0.052 -0.036 -0.004  0.062 -0.094 -0.429 
            gndr1:f gndr1:s
attr                       
gender1                    
intel                      
fun                        
sinc                       
amb                        
attr:gendr1                
gender1:ntl                
gender1:fun                
gender1:snc  0.063         
gender1:amb -0.192   0.091 
optimizer (nloptwrap) convergence code: 0 (OK)
boundary (singular) fit: see help('isSingular')
```
]

---

## (Boundary) singular fit

It is common in practice for complex linear mixed-effects models to result in (almost) **singular fits**. Technically, singularity means that the covariance matrix of the random effects is of less than *full rank*. , which indicates that
* some combinations of the elements of the random-effects vector are perfectly multicollinear
* in models with a single random effects term, an estimated variance is (near) zero.
* in models with two random effects terms (e.g. intercept and slope), typically reflected by a perfect (+/- 1) correlation between slope and intercept
* in models with more than two random effects terms, this can be difficult to spot in the covariance matrix of random effects

--

Singular fits commonly occur in two scenarios:
* a small number (e.g. &lt;5) of units of observation for the random-effect levels
* complex random-effects models with many random effects terms

--

Resolving singular fit involve simplifying the model
* If a variance component is zero, dropping it from the model will have no effect on the estimated quantities.
* Stepwise elimination of redundant random effects terms based on e.g. likelihood-ratio tests.

---

## Diagnosing singular fit

Multicollinearity for random effects terms can be diagnosed via **Principal Components Analysis** (PCA)

.scrollable[

``` r
lme4::rePCA(mod$full_model)
```

```
$pid
Standard deviations (1, .., p=6):
[1] 2.999879e-01 1.729339e-01 1.424068e-01 1.122858e-01 4.309755e-05
[6] 0.000000e+00

Rotation (n x k) = (6 x 6):
            [,1]        [,2]       [,3]        [,4]       [,5]         [,6]
[1,] -0.17881136 -0.54753027 -0.5662734 -0.40712391 -0.3930613 1.653015e-01
[2,] -0.02421826  0.74878896 -0.5373933 -0.30593860  0.1397422 1.918612e-01
[3,] -0.65815830 -0.18918848 -0.1562177  0.29836903  0.5899157 2.638309e-01
[4,] -0.05713415 -0.08557016  0.4853372 -0.77327274  0.3348891 2.091884e-01
[5,]  0.24235807  0.01616251  0.1503984  0.23049155 -0.2067780 9.069168e-01
[6,]  0.68721604 -0.31008055 -0.3285834  0.02346367  0.5683894 6.245005e-17

$iid
Standard deviations (1, .., p=6):
[1] 6.561307e-01 3.228200e-01 1.761823e-01 1.378443e-01 7.115127e-05
[6] 6.195177e-22

Rotation (n x k) = (6 x 6):
            [,1]        [,2]        [,3]        [,4]        [,5]          [,6]
[1,] -0.98004511 -0.14559930 -0.08143338 -0.08000143 -0.06746750  2.699903e-02
[2,]  0.15996952 -0.74698229  0.04408650 -0.58819590 -0.15256320 -2.126820e-01
[3,]  0.06890255  0.29595666 -0.63252810 -0.55502206 -0.03995570  4.448869e-01
[4,] -0.06313755  0.35360933  0.75731675 -0.47481818 -0.09688969  2.502109e-01
[5,] -0.05478910  0.45040333 -0.12427133 -0.29154235 -0.01368052 -8.327710e-01
[6,]  0.04675026  0.07297432 -0.04859178  0.17066523 -0.98030678  1.734723e-17

attr(,"class")
[1] "prcomplist"
```
]

---

## Diagnosing singular fit



``` r
summary(lme4::rePCA(mod$full_model))
```

```
$pid
Importance of components:
                        [,1]   [,2]   [,3]    [,4]     [,5] [,6]
Standard deviation     0.300 0.1729 0.1424 0.11229 4.31e-05    0
Proportion of Variance 0.589 0.1957 0.1327 0.08252 0.00e+00    0
Cumulative Proportion  0.589 0.7847 0.9175 1.00000 1.00e+00    1

$iid
Importance of components:
                         [,1]   [,2]    [,3]    [,4]      [,5]      [,6]
Standard deviation     0.6561 0.3228 0.17618 0.13784 7.115e-05 6.195e-22
Proportion of Variance 0.7362 0.1782 0.05308 0.03249 0.000e+00 0.000e+00
Cumulative Proportion  0.7362 0.9144 0.96751 1.00000 1.000e+00 1.000e+00
```

---

## Independent crossed random intercepts and slopes

.scrollable2[

``` r
mod2 &lt;- afex::mixed(like ~ attr*gender + intel*gender + fun*gender + 
                     sinc*gender + amb*gender + 
                     (1 + attr + intel + fun + sinc + amb||iid) + 
                     (1 + attr + intel + fun + sinc + amb||pid), 
                   data=dat)
summary(mod2)
```

```
Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: like ~ attr * gender + intel * gender + fun * gender + sinc *  
    gender + amb * gender + (1 + attr + intel + fun + sinc +  
    amb || iid) + (1 + attr + intel + fun + sinc + amb || pid)
   Data: data

REML criterion at convergence: 4044.7

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.1068 -0.5228 -0.0034  0.5370  4.3935 

Random effects:
 Groups   Name        Variance  Std.Dev. 
 pid      amb         1.234e-02 1.111e-01
 pid.1    sinc        7.909e-11 8.893e-06
 pid.2    fun         2.715e-03 5.211e-02
 pid.3    intel       3.457e-03 5.879e-02
 pid.4    attr        1.055e-02 1.027e-01
 pid.5    (Intercept) 7.187e-03 8.477e-02
 iid      amb         3.890e-09 6.237e-05
 iid.1    sinc        1.586e-02 1.259e-01
 iid.2    fun         1.825e-02 1.351e-01
 iid.3    intel       2.782e-02 1.668e-01
 iid.4    attr        3.365e-02 1.834e-01
 iid.5    (Intercept) 2.704e-01 5.200e-01
 Residual             7.308e-01 8.548e-01
Number of obs: 1389, groups:  pid, 102; iid, 100

Fixed effects:
                Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)     6.187860   0.064055  95.736202  96.602  &lt; 2e-16 ***
attr            0.370995   0.030321 118.743239  12.236  &lt; 2e-16 ***
gender1         0.024112   0.064055  95.736202   0.376 0.707436    
intel           0.140461   0.036656 110.361304   3.832 0.000212 ***
fun             0.331120   0.027448 109.181304  12.064  &lt; 2e-16 ***
sinc            0.156771   0.030388  71.773744   5.159 2.12e-06 ***
amb             0.097210   0.026950 205.795272   3.607 0.000389 ***
attr:gender1   -0.065904   0.030321 118.743239  -2.174 0.031724 *  
gender1:intel   0.003675   0.036656 110.361304   0.100 0.920332    
gender1:fun    -0.004733   0.027448 109.181304  -0.172 0.863415    
gender1:sinc    0.069588   0.030388  71.773744   2.290 0.024966 *  
gender1:amb     0.043820   0.026950 205.795272   1.626 0.105478    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) attr   gendr1 intel  fun    sinc   amb    attr:1 gndr1:n
attr        -0.019                                                         
gender1      0.010  0.056                                                  
intel        0.001 -0.036 -0.023                                           
fun         -0.050 -0.264 -0.023 -0.037                                    
sinc         0.001 -0.050  0.036 -0.357 -0.096                             
amb          0.007 -0.046 -0.088 -0.233 -0.158 -0.046                      
attr:gendr1  0.056  0.014 -0.019 -0.025 -0.013  0.003  0.012               
gender1:ntl -0.023 -0.025  0.001  0.040  0.055 -0.027 -0.059 -0.036        
gender1:fun -0.023 -0.013 -0.050  0.055 -0.004 -0.013 -0.042 -0.264 -0.037 
gender1:snc  0.036  0.003  0.001 -0.027 -0.013  0.002  0.001 -0.050 -0.357 
gender1:amb -0.088  0.012  0.007 -0.059 -0.042  0.001  0.078 -0.046 -0.233 
            gndr1:f gndr1:s
attr                       
gender1                    
intel                      
fun                        
sinc                       
amb                        
attr:gendr1                
gender1:ntl                
gender1:fun                
gender1:snc -0.096         
gender1:amb -0.158  -0.046 
optimizer (nloptwrap) convergence code: 0 (OK)
boundary (singular) fit: see help('isSingular')
```
]

---


``` r
summary(lme4::rePCA(mod2$full_model))
```

```
$pid
Importance of components:
                         [,1]   [,2]    [,3]    [,4]    [,5]     [,6]
Standard deviation     0.1299 0.1202 0.09917 0.06877 0.06095 1.04e-05
Proportion of Variance 0.3404 0.2911 0.19825 0.09535 0.07490 0.00e+00
Cumulative Proportion  0.3404 0.6315 0.82975 0.92510 1.00000 1.00e+00

$iid
Importance of components:
                         [,1]    [,2]    [,3]    [,4]    [,5]      [,6]
Standard deviation     0.6083 0.21460 0.19512 0.15802 0.14733 7.296e-05
Proportion of Variance 0.7388 0.09196 0.07602 0.04986 0.04335 0.000e+00
Cumulative Proportion  0.7388 0.83077 0.90679 0.95665 1.00000 1.000e+00
```

---

## Removing redundant slopes

.scrollable[

``` r
mod3 &lt;- afex::mixed(like ~ attr*gender + intel*gender + fun*gender + 
                     sinc*gender + amb*gender + 
                     (1 + attr + intel + fun + sinc||iid) + 
                     (1 + attr + intel + fun + amb||pid), 
                   data=dat)
summary(mod3)
```

```
Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: like ~ attr * gender + intel * gender + fun * gender + sinc *  
    gender + amb * gender + (1 + attr + intel + fun + sinc ||  
    iid) + (1 + attr + intel + fun + amb || pid)
   Data: data

REML criterion at convergence: 4044.7

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.1068 -0.5228 -0.0033  0.5370  4.3935 

Random effects:
 Groups   Name        Variance Std.Dev.
 pid      amb         0.012337 0.11107 
 pid.1    fun         0.002718 0.05214 
 pid.2    intel       0.003459 0.05881 
 pid.3    attr        0.010553 0.10273 
 pid.4    (Intercept) 0.007184 0.08476 
 iid      sinc        0.015863 0.12595 
 iid.1    fun         0.018246 0.13508 
 iid.2    intel       0.027823 0.16680 
 iid.3    attr        0.033654 0.18345 
 iid.4    (Intercept) 0.270406 0.52001 
 Residual             0.730755 0.85484 
Number of obs: 1389, groups:  pid, 102; iid, 100

Fixed effects:
                Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)     6.187860   0.064057  95.726881  96.599  &lt; 2e-16 ***
attr            0.370996   0.030321 118.741905  12.235  &lt; 2e-16 ***
gender1         0.024113   0.064057  95.726881   0.376 0.707434    
intel           0.140459   0.036657 110.363062   3.832 0.000212 ***
fun             0.331119   0.027448 109.189182  12.063  &lt; 2e-16 ***
sinc            0.156772   0.030388  71.772748   5.159 2.12e-06 ***
amb             0.097211   0.026949 205.802413   3.607 0.000389 ***
attr:gender1   -0.065905   0.030321 118.741905  -2.174 0.031724 *  
gender1:intel   0.003674   0.036657 110.363062   0.100 0.920353    
gender1:fun    -0.004733   0.027448 109.189182  -0.172 0.863425    
gender1:sinc    0.069589   0.030388  71.772748   2.290 0.024965 *  
gender1:amb     0.043820   0.026949 205.802413   1.626 0.105477    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) attr   gendr1 intel  fun    sinc   amb    attr:1 gndr1:n
attr        -0.019                                                         
gender1      0.010  0.056                                                  
intel        0.001 -0.036 -0.023                                           
fun         -0.050 -0.264 -0.023 -0.037                                    
sinc         0.001 -0.050  0.036 -0.357 -0.096                             
amb          0.007 -0.046 -0.088 -0.233 -0.158 -0.046                      
attr:gendr1  0.056  0.014 -0.019 -0.025 -0.013  0.003  0.012               
gender1:ntl -0.023 -0.025  0.001  0.040  0.055 -0.027 -0.059 -0.036        
gender1:fun -0.023 -0.013 -0.050  0.055 -0.004 -0.013 -0.042 -0.264 -0.037 
gender1:snc  0.036  0.003  0.001 -0.027 -0.013  0.002  0.001 -0.050 -0.357 
gender1:amb -0.088  0.012  0.007 -0.059 -0.042  0.001  0.078 -0.046 -0.233 
            gndr1:f gndr1:s
attr                       
gender1                    
intel                      
fun                        
sinc                       
amb                        
attr:gendr1                
gender1:ntl                
gender1:fun                
gender1:snc -0.096         
gender1:amb -0.158  -0.046 
```
]

---


``` r
summary(lme4::rePCA(mod3$full_model))
```

```
$pid
Importance of components:
                         [,1]   [,2]    [,3]   [,4]    [,5]
Standard deviation     0.1299 0.1202 0.09915 0.0688 0.06099
Proportion of Variance 0.3403 0.2911 0.19818 0.0954 0.07498
Cumulative Proportion  0.3403 0.6314 0.82962 0.9250 1.00000

$iid
Importance of components:
                         [,1]    [,2]    [,3]    [,4]    [,5]
Standard deviation     0.6083 0.21460 0.19513 0.15801 0.14733
Proportion of Variance 0.7388 0.09195 0.07602 0.04985 0.04334
Cumulative Proportion  0.7388 0.83078 0.90681 0.95666 1.00000
```

---



## Fixed and random slopes for sincerity

&lt;img src="lecture5_files/figure-html/unnamed-chunk-10-1.png" width="90%" style="display: block; margin: auto;" /&gt;

---

## Fixed and random slopes for attractiveness

&lt;img src="lecture5_files/figure-html/unnamed-chunk-11-1.png" width="90%" style="display: block; margin: auto;" /&gt;


---

## Testing random effects for partner


``` r
modr &lt;- afex::mixed(like ~ attr*gender + intel*gender + fun*gender + 
                     sinc*gender + amb*gender + 
                     (1 + attr + intel + fun + sinc||iid) + 
                     (1|pid), 
                   data=dat)

anova(modr, mod3)
```

```
Data: data
Models:
modr: like ~ attr * gender + intel * gender + fun * gender + sinc * gender + amb * gender + (1 + attr + intel + fun + sinc || iid) + (1 | pid)
mod3: like ~ attr * gender + intel * gender + fun * gender + sinc * gender + amb * gender + (1 + attr + intel + fun + sinc || iid) + (1 + attr + intel + fun + amb || pid)
     npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)   
modr   19 4100.1 4199.5 -2031.0   4062.1                        
mod3   23 4090.7 4211.2 -2022.4   4044.7 17.318  4   0.001676 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---

## Testing random effects for participants


``` r
modr &lt;- afex::mixed(like ~ attr*gender + intel*gender + fun*gender + 
                     sinc*gender + amb*gender + 
                     (1|iid) + 
                     (1 + attr + intel + fun + amb||pid), 
                   data=dat)

anova(modr, mod3)
```

```
Data: data
Models:
modr: like ~ attr * gender + intel * gender + fun * gender + sinc * gender + amb * gender + (1 | iid) + (1 + attr + intel + fun + amb || pid)
mod3: like ~ attr * gender + intel * gender + fun * gender + sinc * gender + amb * gender + (1 + attr + intel + fun + sinc || iid) + (1 + attr + intel + fun + amb || pid)
     npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)    
modr   19 4160.1 4259.6 -2061.1   4122.1                         
mod3   23 4090.7 4211.2 -2022.4   4044.7 77.398  4  6.195e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---

## Testing random effects for both


``` r
modr &lt;- afex::mixed(like ~ attr*gender + intel*gender + fun*gender + 
                     sinc*gender + amb*gender + 
                     (1|iid) + 
                     (1|pid), 
                   data=dat)

anova(modr, mod3)
```

```
Data: data
Models:
modr: like ~ attr * gender + intel * gender + fun * gender + sinc * gender + amb * gender + (1 | iid) + (1 | pid)
mod3: like ~ attr * gender + intel * gender + fun * gender + sinc * gender + amb * gender + (1 + attr + intel + fun + sinc || iid) + (1 + attr + intel + fun + amb || pid)
     npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)    
modr   15 4167.4 4246.0 -2068.7   4137.4                         
mod3   23 4090.7 4211.2 -2022.4   4044.7 92.697  8  &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---

## Choosing random-effects structure

1. Theory
2. Practical constraints
3. "Maximal" structure
4. "Optimal" structure

---

.scrollable[


``` r
library(buildmer)
buildmer(like ~ attr*gender + intel*gender + fun*gender + 
                     sinc*gender + amb*gender + 
                     (1 + attr + intel + fun + sinc + amb|iid) + 
                     (1 + attr + intel + fun + sinc + amb|pid), 
                   data=dat)
```

```
   grouping         term              block         score Iteration
1      &lt;NA&gt;            1            NA NA 1            NA         1
7      &lt;NA&gt;          fun          NA NA fun -493.97344236         1
2      &lt;NA&gt;         attr         NA NA attr -161.43395918         1
11     &lt;NA&gt;          amb          NA NA amb  -68.97285378         1
5      &lt;NA&gt;        intel        NA NA intel  -36.04107659         1
9      &lt;NA&gt;         sinc         NA NA sinc  -13.05691034         1
3      &lt;NA&gt;       gender       NA NA gender   -0.63430277         1
10     &lt;NA&gt;  gender:sinc  NA NA gender:sinc   -4.36403634         1
4      &lt;NA&gt;  attr:gender  NA NA attr:gender   -6.47115342         1
8      &lt;NA&gt;   gender:fun   NA NA gender:fun   -2.92940188         1
6      &lt;NA&gt; gender:intel NA NA gender:intel   -0.96513420         1
12     &lt;NA&gt;   gender:amb   NA NA gender:amb   -0.03468532         1
13      iid            1           NA iid 1  -60.14782245         1
14      iid         attr        NA iid attr  -22.47555706         1
16      iid          fun         NA iid fun  -13.80530281         1
15      iid        intel       NA iid intel   -8.55943188         1
19      pid            1           NA pid 1   -2.57923460         1
24      pid          amb         NA pid amb   -4.79606624         1
            LRT
1            NA
7            NA
2            NA
11           NA
5            NA
9            NA
3            NA
10 2.257634e-03
4  4.902992e-02
8  8.682273e-01
6  8.004679e-01
12 9.180860e-02
13           NA
14          NaN
16 5.901490e-06
15 6.266924e-05
19           NA
24 8.262185e-03
   grouping         term              block         score Iteration
1      &lt;NA&gt;            1            NA NA 1            NA         2
7      &lt;NA&gt;          fun          NA NA fun -493.97344236         2
2      &lt;NA&gt;         attr         NA NA attr -161.43395918         2
11     &lt;NA&gt;          amb          NA NA amb  -68.97285378         2
5      &lt;NA&gt;        intel        NA NA intel  -36.04107659         2
9      &lt;NA&gt;         sinc         NA NA sinc  -13.05691034         2
3      &lt;NA&gt;       gender       NA NA gender   -0.63430277         2
10     &lt;NA&gt;  gender:sinc  NA NA gender:sinc   -4.36403634         2
4      &lt;NA&gt;  attr:gender  NA NA attr:gender   -6.47115342         2
6      &lt;NA&gt; gender:intel NA NA gender:intel   -0.96513420         2
12     &lt;NA&gt;   gender:amb   NA NA gender:amb   -0.03468532         2
13      iid            1           NA iid 1  -60.14782245         2
14      iid         attr        NA iid attr  -22.47555706         2
16      iid          fun         NA iid fun  -13.80530281         2
15      iid        intel       NA iid intel   -8.55943188         2
19      pid            1           NA pid 1   -2.57923460         2
24      pid          amb         NA pid amb   -4.79606624         2
            LRT
1            NA
7            NA
2            NA
11           NA
5            NA
9            NA
3            NA
10 2.270120e-03
4           NaN
6  8.069275e-01
12 9.260483e-02
13           NA
14          NaN
16 7.464892e-06
15 6.231033e-05
19           NA
24 8.405190e-03
   grouping        term             block         score Iteration          LRT
1      &lt;NA&gt;           1           NA NA 1            NA         3           NA
7      &lt;NA&gt;         fun         NA NA fun -493.97344236         3           NA
2      &lt;NA&gt;        attr        NA NA attr -161.43395918         3           NA
11     &lt;NA&gt;         amb         NA NA amb  -68.97285378         3           NA
5      &lt;NA&gt;       intel       NA NA intel  -36.04107659         3           NA
9      &lt;NA&gt;        sinc        NA NA sinc  -13.05691034         3           NA
3      &lt;NA&gt;      gender      NA NA gender   -0.63430277         3           NA
10     &lt;NA&gt; gender:sinc NA NA gender:sinc   -4.36403634         3 1.431603e-03
4      &lt;NA&gt; attr:gender NA NA attr:gender   -6.47115342         3 1.218491e-02
12     &lt;NA&gt;  gender:amb  NA NA gender:amb   -0.03468532         3 9.496922e-02
13      iid           1          NA iid 1  -60.14782245         3           NA
14      iid        attr       NA iid attr  -22.47555706         3          NaN
16      iid         fun        NA iid fun  -13.80530281         3 7.396870e-06
15      iid       intel      NA iid intel   -8.55943188         3 7.588048e-05
19      pid           1          NA pid 1   -2.57923460         3           NA
24      pid         amb        NA pid amb   -4.79606624         3          NaN
   grouping        term             block        score Iteration          LRT
1      &lt;NA&gt;           1           NA NA 1           NA         4           NA
7      &lt;NA&gt;         fun         NA NA fun -493.9734424         4           NA
2      &lt;NA&gt;        attr        NA NA attr -161.4339592         4           NA
11     &lt;NA&gt;         amb         NA NA amb  -68.9728538         4 1.206132e-17
5      &lt;NA&gt;       intel       NA NA intel  -36.0410766         4           NA
9      &lt;NA&gt;        sinc        NA NA sinc  -13.0569103         4           NA
3      &lt;NA&gt;      gender      NA NA gender   -0.6343028         4           NA
10     &lt;NA&gt; gender:sinc NA NA gender:sinc   -4.3640363         4 1.343040e-04
4      &lt;NA&gt; attr:gender NA NA attr:gender   -6.4711534         4 2.007941e-02
13      iid           1          NA iid 1  -60.1478224         4           NA
14      iid        attr       NA iid attr  -22.4755571         4 6.064284e-12
16      iid         fun        NA iid fun  -13.8053028         4 1.806500e-05
15      iid       intel      NA iid intel   -8.5594319         4 3.332969e-04
```

```
Linear mixed model fit by REML ['lmerModLmerTest']
Formula: like ~ 1 + fun + attr + amb + intel + sinc + gender + sinc:gender +  
    attr:gender + (1 + attr + fun + intel | iid)
   Data: dat
REML criterion at convergence: 4030.72
Random effects:
 Groups   Name        Std.Dev. Corr             
 iid      (Intercept) 0.5281                    
          attr        0.2123   -0.40            
          fun         0.1607    0.16 -0.57      
          intel       0.1928   -0.14 -0.39  0.25
 Residual             0.9053                    
Number of obs: 1389, groups:  iid, 100
Fixed Effects:
 (Intercept)           fun          attr           amb         intel  
     6.16604       0.33922       0.37747       0.07929       0.13728  
        sinc       gender1  sinc:gender1  attr:gender1  
     0.16646       0.02390       0.08990      -0.05853  
```

]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="macros.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
